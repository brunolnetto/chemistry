  version: '3.8'

  services:
    postgres:
      image: postgres:13
      environment:
        POSTGRES_USER: ${POSTGRES_USER}
        POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
        POSTGRES_DB: ${POSTGRES_DB}
      ports:
        - "${POSTGRES_PORT}:${POSTGRES_PORT}"
      volumes:
        - postgres_data:/var/lib/postgresql/data

    backend-app:
      build: 
        context: .
        dockerfile: Dockerfile
        args:
          APPS_COUNT: ${APPS_COUNT:-1}  # Use 1 as default if APPS_COUNT is not set
      ports:
        - "8000:8000"
      depends_on: 
        - postgres
        - logstash
      environment:
        DATABASE_URL: postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:${POSTGRES_PORT}/${POSTGRES_DB}
        POSTGRES_USER: ${POSTGRES_USER}
        POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
        POSTGRES_DB: ${POSTGRES_DB}

    prometheus:
      image: prom/prometheus
      volumes:
        - ./prometheus.yml:/etc/prometheus/prometheus.yml
      ports:
        - "9090:9090"
      command:
        - '--config.file=/etc/prometheus/prometheus.yml'
        - '--web.enable-lifecycle'

    logstash:
      image: docker.elastic.co/logstash/logstash:7.16.3
      volumes:
        - ./logstash-config:/usr/share/logstash/pipeline
      ports:
        - "5000:5000"

    elasticsearch:
      image: docker.elastic.co/elasticsearch/elasticsearch:7.16.3
      ports:
        - "9200:9200"
        - "9300:9300"
      environment:
        - discovery.type=single-node

    kibana:
      image: docker.elastic.co/kibana/kibana:7.16.3
      ports:
        - "5601:5601"
      environment:
        - ELASTICSEARCH_HOSTS=http://elasticsearch:9200

  volumes:
    postgres_data:
